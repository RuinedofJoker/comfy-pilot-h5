<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ComfyUI Agent - å·¥ä½œæµç¼–è¾‘å™¨</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    height: 100vh;
    display: flex;
    background: #1e1e1e;
    overflow: hidden;
}

/* ========== å·¦ä¾§ Session ç®¡ç†åŒºåŸŸ ========== */
.session-sidebar {
    width: 300px;
    background: #2c3e50;
    color: white;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #34495e;
    z-index: 100;
}

.session-header {
    padding: 16px;
    border-bottom: 1px solid #34495e;
    background: #243342;
}

.session-header h2 {
    font-size: 16px;
    margin-bottom: 12px;
    color: #ecf0f1;
}

.new-session-btn {
    width: 100%;
    padding: 10px;
    background: #3498db;
    border: none;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    transition: background 0.2s;
}

.new-session-btn:hover {
    background: #2980b9;
}

.session-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
}

.session-item {
    padding: 12px;
    margin-bottom: 8px;
    background: #34495e;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.session-item:hover {
    background: #415a77;
}

.session-item.active {
    background: #3498db;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
}

.session-item-header {
    display: flex;
    align-items: center;
    gap: 8px;
}

.session-item-icon {
    font-size: 14px;
}

.session-item-title {
    flex: 1;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.session-item-meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 11px;
    opacity: 0.8;
}

.session-item-workflow {
    display: flex;
    align-items: center;
    gap: 4px;
}

.session-item-summary {
    display: flex;
    align-items: center;
    gap: 4px;
}

.session-item-time {
    color: rgba(255, 255, 255, 0.6);
}

.session-footer {
    padding: 12px;
    border-top: 1px solid #34495e;
}

.back-btn {
    width: 100%;
    padding: 10px;
    background: #7f8c8d;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    transition: background 0.2s;
}

.back-btn:hover {
    background: #95a5a6;
}

/* ========== ä¸»å·¥ä½œåŒºåŸŸ ========== */
.main-workspace {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
}

/* ========== é¡¶éƒ¨å·¥å…·æ  ========== */
.toolbar {
    background: #2d2d2d;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #3e3e3e;
}

.toolbar-left {
    display: flex;
    gap: 12px;
    align-items: center;
}

.logo-btn {
    font-size: 20px;
    cursor: pointer;
    padding: 6px 12px;
    background: transparent;
    border: none;
    border-radius: 6px;
    transition: background 0.2s;
}

.logo-btn:hover {
    background: #3e3e3e;
}

.workflow-selector {
    position: relative;
}

.workflow-select-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: #34495e;
    border: none;
    border-radius: 6px;
    color: #ecf0f1;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 200px;
}

.workflow-select-btn:hover {
    background: #415a77;
}

.workflow-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background: #2d2d2d;
    border: 1px solid #3e3e3e;
    border-radius: 8px;
    min-width: 300px;
    max-height: 400px;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s;
    z-index: 1000;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.workflow-selector.active .workflow-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.workflow-dropdown-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid #3e3e3e;
}

.workflow-dropdown-item:last-child {
    border-bottom: none;
}

.workflow-dropdown-item:hover {
    background: #3e3e3e;
}

.workflow-dropdown-item.active {
    background: #3498db;
}

.workflow-item-name {
    font-size: 13px;
    color: #ecf0f1;
    font-weight: 500;
    margin-bottom: 4px;
}

.workflow-item-meta {
    font-size: 11px;
    color: #95a5a6;
}

.service-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: #34495e;
    border-radius: 6px;
    font-size: 12px;
    color: #ecf0f1;
}

.service-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #27ae60;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.btn {
    padding: 8px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
}

.btn:hover:not(:disabled) {
    background: #2980b9;
}

.btn.secondary {
    background: #555;
}

.btn.secondary:hover {
    background: #666;
}

.btn:disabled {
    background: #444;
    color: #888;
    cursor: not-allowed;
}

.workflow-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
    padding: 6px 12px;
    background: #34495e;
    border-radius: 6px;
    font-size: 12px;
    color: #ecf0f1;
}

.workflow-name {
    font-weight: 500;
}

.workflow-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
}

.workflow-status.saved {
    color: #27ae60;
}

.workflow-status.unsaved {
    color: #f39c12;
}

.toolbar-right {
    color: #aaa;
    font-size: 13px;
    display: flex;
    gap: 20px;
    align-items: center;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #27ae60;
}

.status-dot.locked {
    background: #e74c3c;
    animation: pulse 1.5s infinite;
}

/* ========== ComfyUI iframe å®¹å™¨ ========== */
.comfyui-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #252525;
}

.comfyui-iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.comfyui-container.locked::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: 10;
    pointer-events: none;
}

.lock-overlay {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(231, 76, 60, 0.95);
    color: white;
    padding: 20px 40px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 500;
    z-index: 20;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    text-align: center;
}

.comfyui-container.locked .lock-overlay {
    display: block;
}

.lock-overlay-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

/* ========== æ‚¬æµ® Agent å¯¹è¯æ¡† ========== */
.chat-dialog {
    position: absolute;
    right: 20px;
    bottom: 20px;
    width: 420px;
    height: 600px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
    z-index: 200;
    transition: all 0.3s ease;
    resize: both;
    overflow: hidden;
    min-width: 320px;
    min-height: 400px;
    max-width: 800px;
    max-height: 90vh;
}

.chat-dialog.hidden {
    transform: translateY(calc(100% + 40px));
    opacity: 0;
    pointer-events: none;
}

.chat-dialog.minimized {
    height: 56px;
    resize: none;
}

.chat-dialog.minimized .chat-messages,
.chat-dialog.minimized .chat-input-area {
    display: none;
}

.chat-dialog-header {
    background: #3498db;
    color: white;
    padding: 14px 16px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    user-select: none;
}

.chat-dialog-title {
    font-size: 15px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    overflow: hidden;
}

.chat-dialog-title-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.chat-dialog-controls {
    display: flex;
    gap: 8px;
}

.chat-control-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.chat-control-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    background: #f8f9fa;
}

.message {
    margin-bottom: 16px;
    display: flex;
    gap: 10px;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    flex-direction: row-reverse;
}

.avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #3498db;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
    flex-shrink: 0;
}

.message.user .avatar {
    background: #9b59b6;
}

.message-content {
    max-width: 75%;
    background: white;
    padding: 10px 14px;
    border-radius: 12px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    font-size: 13px;
    line-height: 1.5;
}

.message.user .message-content {
    background: #3498db;
    color: white;
}

.workflow-action {
    margin-top: 8px;
    padding: 8px;
    background: #ecf0f1;
    border-radius: 6px;
    font-size: 12px;
    border-left: 3px solid #3498db;
}

.workflow-action strong {
    display: block;
    margin-bottom: 4px;
    color: #2c3e50;
}

.chat-input-area {
    padding: 12px;
    background: white;
    border-top: 1px solid #e0e0e0;
    border-radius: 0 0 12px 12px;
}

.chat-input-container {
    display: flex;
    gap: 8px;
}

.chat-input-container input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 20px;
    font-size: 13px;
    outline: none;
}

.chat-input-container input:focus {
    border-color: #3498db;
}

.chat-send-btn {
    padding: 10px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    font-size: 13px;
    transition: background 0.2s;
}

.chat-send-btn:hover {
    background: #2980b9;
}

.chat-send-btn:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
}

/* ========== è°ƒæ•´å¤§å°æŒ‡ç¤ºå™¨ ========== */
.resize-indicator {
    position: absolute;
    right: 0;
    bottom: 0;
    width: 20px;
    height: 20px;
    cursor: nwse-resize;
    opacity: 0.5;
}

.resize-indicator::after {
    content: 'â‹°';
    position: absolute;
    right: 4px;
    bottom: 2px;
    font-size: 16px;
    color: #95a5a6;
}

/* ========== æ»šåŠ¨æ¡æ ·å¼ ========== */
.session-list::-webkit-scrollbar,
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.session-list::-webkit-scrollbar-track,
.chat-messages::-webkit-scrollbar-track {
    background: transparent;
}

.session-list::-webkit-scrollbar-thumb {
    background: #34495e;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: #ddd;
    border-radius: 3px;
}

.session-list::-webkit-scrollbar-thumb:hover,
.chat-messages::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
</head>
<body>
<!-- å·¦ä¾§ Session ç®¡ç†åŒºåŸŸ -->
<div class="session-sidebar">
    <div class="session-header">
        <h2>ğŸ’¬ Agent ä¼šè¯</h2>
        <button class="new-session-btn" onclick="createNewSession()">+ æ–°å»ºä¼šè¯</button>
    </div>
    <div class="session-list">
        <div class="session-item active" onclick="switchSession(1)">
            <div class="session-item-header">
                <span class="session-item-icon">ğŸŸ¢</span>
                <span class="session-item-title">å¯¹è¯ #1 (è¿›è¡Œä¸­)</span>
            </div>
            <div class="session-item-meta">
                <div class="session-item-workflow">ğŸ“ SDXL å›¾åƒç”Ÿæˆ</div>
                <div class="session-item-summary">âœ… æ·»åŠ äº† ControlNet èŠ‚ç‚¹</div>
                <div class="session-item-time">5 åˆ†é’Ÿå‰</div>
            </div>
        </div>
        <div class="session-item" onclick="switchSession(2)">
            <div class="session-item-header">
                <span class="session-item-icon">âšª</span>
                <span class="session-item-title">å¯¹è¯ #2</span>
            </div>
            <div class="session-item-meta">
                <div class="session-item-workflow">ğŸ“ SDXL å›¾åƒç”Ÿæˆ</div>
                <div class="session-item-summary">âœ… ä¼˜åŒ–äº†é‡‡æ ·å‚æ•°</div>
                <div class="session-item-time">1 å°æ—¶å‰</div>
            </div>
        </div>
        <div class="session-item" onclick="switchSession(3)">
            <div class="session-item-header">
                <span class="session-item-icon">âšª</span>
                <span class="session-item-title">å¯¹è¯ #3</span>
            </div>
            <div class="session-item-meta">
                <div class="session-item-workflow">ğŸ“ ControlNet å§¿æ€</div>
                <div class="session-item-summary">ğŸ’¬ ä»…å’¨è¯¢ï¼Œæ— ä¿®æ”¹</div>
                <div class="session-item-time">æ˜¨å¤©</div>
            </div>
        </div>
    </div>
    <div class="session-footer">
        <button class="back-btn" onclick="goBack()">â† è¿”å›æœåŠ¡é€‰æ‹©</button>
    </div>
</div>

<!-- ä¸»å·¥ä½œåŒºåŸŸ -->
<div class="main-workspace">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <button class="logo-btn" onclick="goHome()" title="è¿”å›é¦–é¡µ">ğŸ¤–</button>
            <div class="workflow-selector" id="workflowSelector">
                <button class="workflow-select-btn" onclick="toggleWorkflowDropdown()">
                    <span>ğŸ“ SDXL å›¾åƒç”Ÿæˆ</span>
                    <span>â–¼</span>
                </button>
                <div class="workflow-dropdown" id="workflowDropdown">
                    <!-- å·¥ä½œæµåˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="service-indicator">
                <span class="service-dot"></span>
                <span>ç”Ÿäº§ç¯å¢ƒ ComfyUI</span>
            </div>
            <div class="workflow-info">
                <div class="workflow-status saved" id="workflowStatus">
                    <span>ğŸŸ¢</span>
                    <span id="workflowStatusText">å·²ä¿å­˜</span>
                </div>
            </div>
            <button class="btn secondary" id="saveBtn" onclick="saveWorkflow()">ğŸ’¾ ä¿å­˜ (Ctrl+S)</button>
            <button class="btn secondary">ğŸ“¤ å¯¼å‡º</button>
        </div>
        <div class="toolbar-right">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">å°±ç»ª</span>
            </div>
        </div>
    </div>

    <!-- ComfyUI iframe å®¹å™¨ -->
    <div class="comfyui-container" id="comfyuiContainer">
        <!-- è¿™é‡ŒåµŒå…¥ ComfyUI åŸç”Ÿç•Œé¢ -->
        <!-- å®é™…é¡¹ç›®ä¸­ä½¿ç”¨: <iframe class="comfyui-iframe" src="http://192.168.1.100:8188" id="comfyuiFrame"></iframe> -->

        <!-- æ¼”ç¤ºç”¨ï¼šæ¨¡æ‹Ÿ ComfyUI ç•Œé¢ -->
        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #7f8c8d; font-size: 18px; flex-direction: column; gap: 16px;">
            <div style="font-size: 64px;">ğŸ–¼ï¸</div>
            <div>ComfyUI å·¥ä½œæµç¼–è¾‘å™¨</div>
            <div style="font-size: 14px; opacity: 0.7;">å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šåµŒå…¥ ComfyUI iframe</div>
            <div style="font-size: 12px; font-family: monospace; background: #2d2d2d; padding: 8px 16px; border-radius: 6px; color: #ecf0f1;">
                &lt;iframe src="http://192.168.1.100:8188"&gt;&lt;/iframe&gt;
            </div>
        </div>

        <!-- é”å®šé®ç½© -->
        <div class="lock-overlay">
            <div class="lock-overlay-icon">ğŸ”’</div>
            <div>Agent æ­£åœ¨ç¼–è¾‘å·¥ä½œæµ...</div>
            <div style="font-size: 13px; margin-top: 8px; opacity: 0.9;">è¯·ç¨å€™ï¼Œç¼–è¾‘å®Œæˆåå°†è‡ªåŠ¨è§£é”</div>
        </div>
    </div>

    <!-- æ‚¬æµ® Agent å¯¹è¯æ¡† -->
    <div class="chat-dialog" id="chatDialog">
        <div class="chat-dialog-header" id="chatHeader">
            <div class="chat-dialog-title">
                <span>ğŸ¤–</span>
                <span class="chat-dialog-title-text" id="chatSessionName">SDXL å›¾åƒç”Ÿæˆå·¥ä½œæµ</span>
            </div>
            <div class="chat-dialog-controls">
                <button class="chat-control-btn" onclick="toggleMinimize()" title="æœ€å°åŒ–/è¿˜åŸ">âˆ’</button>
                <button class="chat-control-btn" onclick="closeChat()" title="å…³é—­">Ã—</button>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘æ˜¯ ComfyUI å·¥ä½œæµåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ åˆ›å»ºå’Œç¼–è¾‘å·¥ä½œæµã€‚ä½ æƒ³åšä»€ä¹ˆï¼Ÿ
                </div>
            </div>
            <div class="message user">
                <div class="avatar">U</div>
                <div class="message-content">
                    æˆ‘æƒ³åˆ›å»ºä¸€ä¸ª SDXL å›¾åƒç”Ÿæˆå·¥ä½œæµ
                </div>
            </div>
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    å¥½çš„ï¼æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†åŸºç¡€çš„ SDXL å·¥ä½œæµï¼ŒåŒ…å«ä»¥ä¸‹èŠ‚ç‚¹ï¼š
                    <div class="workflow-action">
                        <strong>âœ… å·¥ä½œæµå·²åˆ›å»ºï¼š</strong>
                        1. CheckpointLoader (SDXL æ¨¡å‹)<br>
                        2. CLIPTextEncode (æ­£å‘/è´Ÿå‘æç¤ºè¯)<br>
                        3. KSampler (é‡‡æ ·å™¨)<br>
                        4. VAEDecode + SaveImage
                    </div>
                    ä½ æƒ³ä¿®æ”¹å“ªäº›å‚æ•°æˆ–æ·»åŠ æ–°èŠ‚ç‚¹å—ï¼Ÿ
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="è¾“å…¥ä½ çš„éœ€æ±‚..." onkeypress="handleChatKeyPress(event)" />
                <button class="chat-send-btn" onclick="sendMessage()">å‘é€</button>
            </div>
        </div>
        <div class="resize-indicator"></div>
    </div>
</div>

<script>
// ========== å…¨å±€çŠ¶æ€ ==========
let isWorkflowLocked = false;
let currentSessionId = 1;
let isChatOpen = true;
let isChatMinimized = false;
let hasUnsavedChanges = false;
let currentWorkflowName = 'SDXL å›¾åƒç”Ÿæˆ';
let currentWorkflowId = 1;

// ========== å·¥ä½œæµæ•°æ® ==========
const workflows = [
    { id: 1, name: 'SDXL å›¾åƒç”Ÿæˆ', sessions: 5, lastUsed: '2 å°æ—¶å‰' },
    { id: 2, name: 'ControlNet å§¿æ€æ§åˆ¶', sessions: 3, lastUsed: '1 å¤©å‰' },
    { id: 3, name: 'è§†é¢‘å¸§æ’å€¼', sessions: 2, lastUsed: '3 å¤©å‰' },
    { id: 4, name: 'å›¾åƒè¶…åˆ†è¾¨ç‡', sessions: 4, lastUsed: '5 å¤©å‰' }
];

// ========== å·¥ä½œæµé€‰æ‹©å™¨ ==========
function toggleWorkflowDropdown() {
    const selector = document.getElementById('workflowSelector');
    selector.classList.toggle('active');
}

function renderWorkflowDropdown() {
    const dropdown = document.getElementById('workflowDropdown');
    dropdown.innerHTML = workflows.map(wf => `
        <div class="workflow-dropdown-item ${wf.id === currentWorkflowId ? 'active' : ''}"
             onclick="selectWorkflow(${wf.id})">
            <div class="workflow-item-name">${wf.name}</div>
            <div class="workflow-item-meta">${wf.sessions} ä¼šè¯ Â· ${wf.lastUsed}</div>
        </div>
    `).join('');
}

function selectWorkflow(workflowId) {
    if (hasUnsavedChanges) {
        if (!confirm('âš ï¸ æœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\nåˆ‡æ¢å·¥ä½œæµå°†ä¸¢å¤±æœªä¿å­˜çš„ä¿®æ”¹\n\nç¡®å®šè¦åˆ‡æ¢å—ï¼Ÿ')) {
            return;
        }
    }

    currentWorkflowId = workflowId;
    const workflow = workflows.find(w => w.id === workflowId);
    if (workflow) {
        currentWorkflowName = workflow.name;
        document.querySelector('.workflow-select-btn span:first-child').textContent = `ğŸ“ ${workflow.name}`;
        hasUnsavedChanges = false;
        updateWorkflowStatus();
        renderWorkflowDropdown();
    }

    toggleWorkflowDropdown();
}

function goHome() {
    if (hasUnsavedChanges) {
        if (!confirm('âš ï¸ æœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\nè¿”å›é¦–é¡µå°†ä¸¢å¤±æœªä¿å­˜çš„ä¿®æ”¹\n\nç¡®å®šè¦è¿”å›å—ï¼Ÿ')) {
            return;
        }
    }
    window.location.href = '03-user-service-selection.html';
}

// ç‚¹å‡»å¤–éƒ¨å…³é—­å·¥ä½œæµä¸‹æ‹‰èœå•
document.addEventListener('click', function(event) {
    const selector = document.getElementById('workflowSelector');
    if (selector && !selector.contains(event.target)) {
        selector.classList.remove('active');
    }
});

// ========== å·¥ä½œæµä¿å­˜ç®¡ç† ==========
function saveWorkflow() {
    if (!hasUnsavedChanges) {
        alert('ğŸ’¡ å·¥ä½œæµæ²¡æœ‰ä¿®æ”¹ï¼Œæ— éœ€ä¿å­˜');
        return;
    }

    // æ¨¡æ‹Ÿä¿å­˜æ“ä½œ
    console.log('ä¿å­˜å·¥ä½œæµ:', currentWorkflowName);

    // æ›´æ–°ä¿å­˜çŠ¶æ€
    hasUnsavedChanges = false;
    updateWorkflowStatus();

    alert('âœ… å·¥ä½œæµå·²ä¿å­˜ï¼');
}

function markAsUnsaved() {
    hasUnsavedChanges = true;
    updateWorkflowStatus();
}

function updateWorkflowStatus() {
    const statusElement = document.getElementById('workflowStatus');
    const statusTextElement = document.getElementById('workflowStatusText');

    if (hasUnsavedChanges) {
        statusElement.classList.remove('saved');
        statusElement.classList.add('unsaved');
        statusElement.innerHTML = '<span>âš ï¸</span><span id="workflowStatusText">æœ‰æœªä¿å­˜çš„ä¿®æ”¹</span>';
    } else {
        statusElement.classList.remove('unsaved');
        statusElement.classList.add('saved');
        statusElement.innerHTML = '<span>ğŸŸ¢</span><span id="workflowStatusText">å·²ä¿å­˜</span>';
    }
}

// ========== Session ç®¡ç† ==========
function createNewSession() {
    const sessionName = prompt('è¯·è¾“å…¥æ–°ä¼šè¯åç§°ï¼š');
    if (sessionName && sessionName.trim()) {
        alert(`âœ… å·²åˆ›å»ºæ–°ä¼šè¯ï¼š${sessionName}`);
        // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šè°ƒç”¨ API åˆ›å»ºä¼šè¯
    }
}

function switchSession(sessionId) {
    // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„ä¿®æ”¹
    if (hasUnsavedChanges) {
        const confirmed = confirm('âš ï¸ æœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\nå½“å‰å·¥ä½œæµæœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\n[ç¡®å®š] ä¿å­˜å¹¶åˆ‡æ¢\n[å–æ¶ˆ] æ”¾å¼ƒä¿®æ”¹å¹¶åˆ‡æ¢');

        if (confirmed) {
            saveWorkflow();
        } else {
            hasUnsavedChanges = false;
            updateWorkflowStatus();
        }
    }

    currentSessionId = sessionId;

    // æ›´æ–°ä¼šè¯åˆ—è¡¨æ¿€æ´»çŠ¶æ€
    document.querySelectorAll('.session-item').forEach((item, index) => {
        item.classList.toggle('active', index + 1 === sessionId);
    });

    // æ›´æ–°å¯¹è¯æ¡†æ ‡é¢˜
    const sessionNames = [
        'å¯¹è¯ #1 (è¿›è¡Œä¸­)',
        'å¯¹è¯ #2',
        'å¯¹è¯ #3'
    ];
    document.getElementById('chatSessionName').textContent = sessionNames[sessionId - 1];

    // æ‰“å¼€å¯¹è¯æ¡†ï¼ˆå¦‚æœå·²å…³é—­ï¼‰
    if (!isChatOpen) {
        openChat();
    }

    // åŠ è½½å¯¹åº”ä¼šè¯çš„æ¶ˆæ¯å’Œå·¥ä½œæµç‰ˆæœ¬
    loadSessionMessages(sessionId);
    loadSessionWorkflow(sessionId);
}

function loadSessionMessages(sessionId) {
    const messagesContainer = document.getElementById('chatMessages');

    // ç¤ºä¾‹ï¼šä¸åŒä¼šè¯æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
    if (sessionId === 2) {
        messagesContainer.innerHTML = `
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘å¯ä»¥å¸®ä½ ä¼˜åŒ–å·¥ä½œæµå‚æ•°ã€‚
                </div>
            </div>
            <div class="message user">
                <div class="avatar">U</div>
                <div class="message-content">
                    å¸®æˆ‘ä¼˜åŒ–ä¸€ä¸‹é‡‡æ ·å‚æ•°
                </div>
            </div>
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    å¥½çš„ï¼æˆ‘å·²ç»ä¼˜åŒ–äº†é‡‡æ ·å‚æ•°ã€‚
                    <div class="workflow-action">
                        <strong>âœ… å·¥ä½œæµå·²æ›´æ–°ï¼š</strong>
                        è°ƒæ•´äº† KSampler çš„ steps å’Œ cfg å‚æ•°
                    </div>
                </div>
            </div>
        `;
    } else if (sessionId === 3) {
        messagesContainer.innerHTML = `
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
                </div>
            </div>
            <div class="message user">
                <div class="avatar">U</div>
                <div class="message-content">
                    ControlNet çš„æƒé‡åº”è¯¥è®¾ç½®å¤šå°‘ï¼Ÿ
                </div>
            </div>
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    ä¸€èˆ¬å»ºè®®è®¾ç½®åœ¨ 0.5-1.0 ä¹‹é—´ï¼Œå…·ä½“å–å†³äºä½ çš„éœ€æ±‚ã€‚
                </div>
            </div>
        `;
    }
    // å…¶ä»–ä¼šè¯ä¿æŒåŸæœ‰æ¶ˆæ¯...

    // æ»šåŠ¨åˆ°åº•éƒ¨
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function loadSessionWorkflow(sessionId) {
    // æ¨¡æ‹ŸåŠ è½½å†å²å¯¹è¯å¯¹åº”çš„å·¥ä½œæµç‰ˆæœ¬
    console.log('åŠ è½½ä¼šè¯ #' + sessionId + ' å¯¹åº”çš„å·¥ä½œæµç‰ˆæœ¬');

    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šï¼š
    // 1. ä»åç«¯è·å–è¯¥ä¼šè¯å¯¹åº”çš„å·¥ä½œæµç‰ˆæœ¬
    // 2. å°†ç‰ˆæœ¬å†…å®¹åŠ è½½åˆ° iframe
    // 3. æ ‡è®°ä¸ºå·²åŠ è½½å†å²ç‰ˆæœ¬ï¼ˆä½†ä¸æ”¹å˜æ¿€æ´»ç‰ˆæœ¬ï¼‰

    alert(`ğŸ“œ å·²åŠ è½½å¯¹è¯ #${sessionId} å¯¹åº”çš„å·¥ä½œæµç‰ˆæœ¬\n\nè¿™æ˜¯å†å²ç‰ˆæœ¬çš„å¿«ç…§ï¼Œä½ å¯ä»¥æŸ¥çœ‹æˆ–ç»§ç»­ç¼–è¾‘ã€‚\nä¿å­˜åå°†è¦†ç›–å½“å‰æ¿€æ´»ç‰ˆæœ¬ã€‚`);
}

function goBack() {
    if (confirm('ç¡®å®šè¦è¿”å›æœåŠ¡é€‰æ‹©é¡µé¢å—ï¼Ÿ\n\næœªä¿å­˜çš„å·¥ä½œæµå¯èƒ½ä¼šä¸¢å¤±ã€‚')) {
        window.location.href = '03-user-service-selection.html';
    }
}

// ========== å¯¹è¯æ¡†æ§åˆ¶ ==========
function closeChat() {
    document.getElementById('chatDialog').classList.add('hidden');
    isChatOpen = false;
}

function openChat() {
    document.getElementById('chatDialog').classList.remove('hidden');
    document.getElementById('chatDialog').classList.remove('minimized');
    isChatOpen = true;
    isChatMinimized = false;
}

function toggleMinimize() {
    const chatDialog = document.getElementById('chatDialog');
    isChatMinimized = !isChatMinimized;
    chatDialog.classList.toggle('minimized', isChatMinimized);
}

// ========== å·¥ä½œæµé”å®šæœºåˆ¶ ==========
function lockWorkflow() {
    isWorkflowLocked = true;
    document.getElementById('comfyuiContainer').classList.add('locked');
    document.getElementById('saveBtn').disabled = true;
    document.getElementById('statusDot').classList.add('locked');
    document.getElementById('statusText').textContent = 'Agent ç¼–è¾‘ä¸­';

    // å®é™…é¡¹ç›®ä¸­é€šè¿‡ postMessage é€šçŸ¥ iframe
    // window.frames['comfyuiFrame'].postMessage({ type: 'LOCK_WORKFLOW' }, '*');
}

function unlockWorkflow() {
    isWorkflowLocked = false;
    document.getElementById('comfyuiContainer').classList.remove('locked');
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('statusDot').classList.remove('locked');
    document.getElementById('statusText').textContent = 'å°±ç»ª';

    // å®é™…é¡¹ç›®ä¸­é€šè¿‡ postMessage é€šçŸ¥ iframe
    // window.frames['comfyuiFrame'].postMessage({ type: 'UNLOCK_WORKFLOW' }, '*');
}

// ========== æ¶ˆæ¯å‘é€ ==========
function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();

    if (!message) return;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage('user', message);
    input.value = '';

    // æ¨¡æ‹Ÿ Agent å“åº”
    setTimeout(() => {
        simulateAgentResponse(message);
    }, 1000);
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function addMessage(type, content) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    const avatar = type === 'user' ? 'U' : 'AI';
    messageDiv.innerHTML = `
        <div class="avatar">${avatar}</div>
        <div class="message-content">${content}</div>
    `;

    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ========== Agent å“åº”æ¨¡æ‹Ÿ ==========
function simulateAgentResponse(userMessage) {
    const lowerMessage = userMessage.toLowerCase();

    if (lowerMessage.includes('æ·»åŠ ') || lowerMessage.includes('ä¿®æ”¹') || lowerMessage.includes('ç¼–è¾‘')) {
        // æ¨¡æ‹Ÿ Agent ç¼–è¾‘å·¥ä½œæµ
        lockWorkflow();

        addMessage('agent', `
            å¥½çš„ï¼Œæˆ‘æ­£åœ¨ç¼–è¾‘å·¥ä½œæµ...
            <div class="workflow-action">
                <strong>ğŸ”§ æ­£åœ¨æ‰§è¡Œæ“ä½œï¼š</strong>
                ${userMessage}
            </div>
        `);

        // 3ç§’åè§£é”å¹¶æ ‡è®°ä¸ºæœªä¿å­˜
        setTimeout(() => {
            unlockWorkflow();
            markAsUnsaved(); // æ ‡è®°ä¸ºæœªä¿å­˜
            addMessage('agent', `
                âœ… å·¥ä½œæµå·²æ›´æ–°å®Œæˆï¼
                <div class="workflow-action">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>
                    å·¥ä½œæµå·²ä¿®æ”¹ï¼Œè®°å¾—ä¿å­˜ (Ctrl+S)
                </div>
            `);
        }, 3000);
    } else {
        addMessage('agent', `æ”¶åˆ°ä½ çš„æ¶ˆæ¯ï¼š"${userMessage}"ã€‚æˆ‘è¯¥å¦‚ä½•å¸®åŠ©ä½ ï¼Ÿ`);
    }
}

// ========== å¯¹è¯æ¡†æ‹–åŠ¨åŠŸèƒ½ ==========
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;

const chatDialog = document.getElementById('chatDialog');
const chatHeader = document.getElementById('chatHeader');

chatHeader.addEventListener('mousedown', function(e) {
    if (e.target.closest('.chat-control-btn')) return;

    isDragging = true;
    const rect = chatDialog.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;

    chatDialog.style.transition = 'none';
});

document.addEventListener('mousemove', function(e) {
    if (!isDragging) return;

    const x = e.clientX - dragOffsetX;
    const y = e.clientY - dragOffsetY;

    chatDialog.style.right = 'auto';
    chatDialog.style.bottom = 'auto';
    chatDialog.style.left = x + 'px';
    chatDialog.style.top = y + 'px';
});

document.addEventListener('mouseup', function() {
    if (isDragging) {
        isDragging = false;
        chatDialog.style.transition = '';
    }
});

// ========== iframe é€šä¿¡æœºåˆ¶ï¼ˆå®é™…é¡¹ç›®ä¸­ä½¿ç”¨ï¼‰==========
// ç›‘å¬æ¥è‡ª ComfyUI iframe çš„æ¶ˆæ¯
window.addEventListener('message', function(event) {
    // éªŒè¯æ¶ˆæ¯æ¥æº
    // if (event.origin !== 'http://192.168.1.100:8188') return;

    const message = event.data;

    switch (message.type) {
        case 'WORKFLOW_CHANGED':
            console.log('å·¥ä½œæµå·²æ›´æ”¹:', message.payload);
            break;
        case 'WORKFLOW_EXECUTED':
            console.log('å·¥ä½œæµå·²æ‰§è¡Œ:', message.payload);
            break;
        case 'NODE_ADDED':
            console.log('èŠ‚ç‚¹å·²æ·»åŠ :', message.payload);
            break;
        default:
            console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message);
    }
});

// å‘ ComfyUI iframe å‘é€æ¶ˆæ¯çš„ç¤ºä¾‹å‡½æ•°
function sendToComfyUI(type, payload) {
    const iframe = document.getElementById('comfyuiFrame');
    if (iframe && iframe.contentWindow) {
        iframe.contentWindow.postMessage({ type, payload }, '*');
    }
}

// ========== é”®ç›˜å¿«æ·é”® ==========
document.addEventListener('keydown', function(e) {
    // Ctrl+S ä¿å­˜å·¥ä½œæµ
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveWorkflow();
    }
});

// ========== æ¨¡æ‹Ÿç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘ï¼ˆæ¼”ç¤ºç”¨ï¼‰==========
// å®é™…é¡¹ç›®ä¸­ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨ iframe å†…å®¹å˜åŒ–æ—¶è¢«è°ƒç”¨
function simulateUserEdit() {
    markAsUnsaved();
    console.log('æ£€æµ‹åˆ°å·¥ä½œæµä¿®æ”¹');
}

// ========== åˆå§‹åŒ– ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('ComfyUI Agent å·¥ä½œæµç¼–è¾‘å™¨å·²åŠ è½½');

    // åˆå§‹åŒ–å·¥ä½œæµä¸‹æ‹‰èœå•
    renderWorkflowDropdown();

    // ç‚¹å‡»ä¼šè¯é¡¹æ—¶æ‰“å¼€å¯¹è¯æ¡†
    document.querySelectorAll('.session-item').forEach(item => {
        item.addEventListener('click', () => {
            if (!isChatOpen) {
                openChat();
            }
        });
    });

    // æ¼”ç¤ºï¼š5ç§’åæ¨¡æ‹Ÿç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘
    setTimeout(() => {
        console.log('ğŸ’¡ æ¼”ç¤ºæç¤ºï¼š5ç§’åå°†æ¨¡æ‹Ÿç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘å·¥ä½œæµ');
        setTimeout(() => {
            simulateUserEdit();
            alert('ğŸ’¡ æ¼”ç¤ºï¼šæ¨¡æ‹Ÿç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘äº†å·¥ä½œæµ\n\né¡¶éƒ¨çŠ¶æ€å·²å˜ä¸º"æœ‰æœªä¿å­˜çš„ä¿®æ”¹"\n\nä½ å¯ä»¥æŒ‰ Ctrl+S æˆ–ç‚¹å‡»ä¿å­˜æŒ‰é’®ä¿å­˜');
        }, 5000);
    }, 0);
});
</script>
</body>
</html>
