# ComfyUI Agent 代理系统 - 原型设计文档

## 📋 系统概述

本系统作为 ComfyUI 的代理层，统一管理多个 ComfyUI 服务实例，为用户提供增强的 AI Agent 辅助功能。

## 🎯 核心设计理念

### 1. 多对多关系模型

```
ComfyUI 服务 ←→ 工作流 ←→ Chat Agent Session
     (1)           (N)            (M)
```

- **ComfyUI 服务**：可以有多个工作流
- **工作流**：可以有多个 Chat Session

### 2. 用户角色设计

#### 管理员用户
- 管理 ComfyUI 服务实例（增删改查）
- 查看服务状态和监控
- 管理用户权限（先完成其他的功能）

#### 普通用户
- 选择可用的 ComfyUI 服务
- 创建和编辑工作流
- 使用 AI Agent 辅助功能
- 管理自己的 Chat Session

### 3. 技术架构

#### 前端架构
```
┌─────────────────────────────────────────┐
│         用户界面层                        │
│  ┌──────────┐  ┌──────────┐  ┌────────┐ │
│  │ 登录页面  │  │ 服务选择  │  │ 管理后台│ │
│  └──────────┘  └──────────┘  └────────┘ │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         工作流编辑层                      │
│  ┌──────────────────────────────────┐   │
│  │  Session 管理 │ ComfyUI iframe   │   │
│  │  (左侧边栏)   │  (中间主区域)     │   │
│  │               │                  │   │
│  │               │  ┌─────────────┐ │   │
│  │               │  │ 悬浮聊天框   │ │   │
│  │               │  │ (可调整)     │ │   │
│  │               │  └─────────────┘ │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         通信层                           │
│  ┌──────────┐  ┌──────────┐            │
│  │ postMessage│  │ WebSocket│            │
│  │ (iframe)  │  │ (Agent)  │            │
│  └──────────┘  └──────────┘            │
└─────────────────────────────────────────┘
```

#### iframe 通信机制
```javascript
// 父页面 → ComfyUI iframe
window.frames['comfyui'].postMessage({
  type: 'LOCK_WORKFLOW',
  payload: { reason: 'Agent editing' }
}, '*');

// ComfyUI iframe → 父页面
window.parent.postMessage({
  type: 'WORKFLOW_CHANGED',
  payload: { workflow: {...} }
}, '*');
```

## 页面列表

// TODO



## 用户流程

### 管理员流程
```
登录 → 管理后台 → 服务管理 → 添加/编辑服务 → 保存
                ↓
              监控服务状态
```

### 普通用户流程

#### 流程 1: 新用户首次使用
```
登录页 → 服务选择页 → 选择服务 → 工作流编辑器(默认会创建一个新的未保存工作流，默认名字Unsaved Workflow[有别的这个名字的工作流这里保存名字后面带(1/2)数字] → 与 Agent 对话 → 保存工作流(需要手动给工作流命名)
```

#### 流程 2: 查看和管理工作流
```
服务选择页 → 点击"我的工作流" → 工作流列表页
                                    ↓
                            [搜索/筛选/排序工作流]
                                    ↓
                            点击工作流卡片
                                    ↓
                    自动进入该工作流最后使用的服务
                                    ↓
                            工作流编辑器(已加载工作流)
```

#### 流程 3: 编辑现有工作流

```
在一个已经加载的工作流编辑器 → 发生改变时上面提示有未保存的修改 → 用户点保存按钮或ctrl + s保存工作流当前状态到当前工作流激活态版本 → 有未保存的修改提示变成已保存
```

#### 流程 4: 切换现有工作流

```
工作流编辑器 → 选择工作流(下拉菜单) → 编辑工作流
                                        ↓
                                如果这里有未保存修改弹窗提示弹窗
                                        ↓
                                     点击保存或不保存直接切换
                                        ↓
                                    保存成功
                                        ↓
                                    左边的chat session切换到对应工作流的历史session
```

#### 流程 5: 使用 Agent 辅助编辑
```
工作流编辑器 → 点击会话/新建会话 → 悬浮对话框打开
                                        ↓
                                输入需求对话
                                        ↓
                                Agent 理解需求
                                        ↓
                            工作流自动锁定(防止冲突)
                                        ↓
                            Agent 自动编辑工作流
                                        ↓
                            工作流自动解锁
                                        ↓
                            标记为"有未保存的修改"
                                        ↓
                                用户保存工作流
```

#### 流程 5: 会话管理
```
工作流编辑器 → 左侧会话列表 → 点击历史会话
                                    ↓
                            加载该会话的消息历史
                                    ↓
                            加载该会话对应的工作流版本快照
                                    ↓
                            继续对话或查看历史
                                    ↓
                            [可选] 保存为新版本
```

#### 流程 6: 个人信息管理
```
任意页面 → 点击用户头像 → 下拉菜单
                            ↓
                    选择"个人信息"
                            ↓
                    个人信息页面
                            ↓
            [编辑信息/修改密码/查看统计]
                            ↓
                        保存修改
```
