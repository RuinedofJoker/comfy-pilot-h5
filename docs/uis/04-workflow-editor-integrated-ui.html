<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å·¥ä½œæµç¼–è¾‘å™¨ - ComfyUI Agent</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    height: 100vh;
    display: flex;
    background: #1e1e1e;
    color: #cccccc;
    overflow: hidden;
}

/* ========== SVG å›¾æ ‡æ ·å¼ ========== */
.icon {
    width: 16px;
    height: 16px;
    fill: currentColor;
    flex-shrink: 0;
}

.icon-lg {
    width: 20px;
    height: 20px;
}

.icon-xl {
    width: 24px;
    height: 24px;
}

/* ========== å·¦ä¾§ä¼šè¯ç®¡ç†åŒºåŸŸ ========== */
.session-sidebar {
    width: 280px;
    background: #282828;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #3a3a3a;
    z-index: 100;
}

.session-header {
    padding: 12px;
    border-bottom: 1px solid #3a3a3a;
    background: #242424;
}

.session-header-title {
    font-size: 13px;
    margin-bottom: 10px;
    color: #999999;
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.new-session-btn {
    width: 100%;
    padding: 6px 10px;
    background: #3a3a3a;
    border: 1px solid #4a4a4a;
    color: #cccccc;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 400;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.new-session-btn:hover {
    background: #454545;
    border-color: #555555;
    color: #ffffff;
}

.session-list {
    flex: 1;
    overflow-y: auto;
    padding: 6px;
}

.session-item {
    padding: 10px;
    margin-bottom: 4px;
    background: #2a2a2a;
    border: 1px solid transparent;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.15s;
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.session-item:hover {
    background: #333333;
    border-color: #3a3a3a;
}

.session-item.active {
    background: #3a3a3a;
    border-color: #4a4a4a;
    box-shadow: none;
}

.session-item-header {
    display: flex;
    align-items: center;
    gap: 8px;
}

.session-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #27ae60;
    flex-shrink: 0;
}

.session-status-dot.idle {
    background: #999999;
}

.session-item-title {
    flex: 1;
    font-weight: 400;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #cccccc;
}

.session-item.active .session-item-title {
    color: #ffffff;
}

.session-item-meta {
    display: flex;
    flex-direction: column;
    gap: 3px;
    font-size: 11px;
    color: #777777;
}

.session-item.active .session-item-meta {
    color: #999999;
}

.session-meta-row {
    display: flex;
    align-items: center;
    gap: 4px;
}

.session-footer {
    padding: 12px;
    border-top: 1px solid #444444;
}

.back-btn {
    width: 100%;
    padding: 8px 12px;
    background: #2a2a2a;
    color: #cccccc;
    border: 1px solid #444444;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.back-btn:hover {
    background: #3a3a3a;
    border-color: #555555;
    color: #ffffff;
}

/* ========== ä¸»å·¥ä½œåŒºåŸŸ ========== */
.main-workspace {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
}

/* ========== é¡¶éƒ¨å·¥å…·æ  ========== */
.toolbar {
    background: #242424;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #3a3a3a;
}

.toolbar-left {
    display: flex;
    gap: 8px;
    align-items: center;
}

.logo-btn {
    padding: 4px 8px;
    background: transparent;
    border: none;
    color: #999999;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.logo-btn:hover {
    background: #2a2a2a;
    color: #cccccc;
}

.workflow-selector {
    position: relative;
}

.workflow-select-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 3px;
    color: #cccccc;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
    min-width: 180px;
}

.workflow-select-btn:hover {
    background: #333333;
    border-color: #4a4a4a;
    color: #ffffff;
}

.workflow-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background: #353535;
    border: 1px solid #444444;
    border-radius: 6px;
    min-width: 300px;
    max-height: 400px;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s;
    z-index: 1000;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
}

.workflow-selector.active .workflow-dropdown {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.workflow-dropdown-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s;
    border-bottom: 1px solid #444444;
}

.workflow-dropdown-item:last-child {
    border-bottom: none;
}

.workflow-dropdown-item:hover {
    background: #2a2a2a;
}

.workflow-dropdown-item.active {
    background: #4a9eff;
}

.workflow-item-name {
    font-size: 13px;
    color: #ffffff;
    font-weight: 500;
    margin-bottom: 4px;
}

.workflow-item-meta {
    font-size: 11px;
    color: #999999;
    display: flex;
    align-items: center;
    gap: 4px;
}

.workflow-dropdown-item.active .workflow-item-meta {
    color: rgba(255, 255, 255, 0.8);
}

.service-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: #2a2a2a;
    border: 1px solid #444444;
    border-radius: 4px;
    font-size: 12px;
    color: #cccccc;
}

.service-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #27ae60;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.workflow-status {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: #2a2a2a;
    border: 1px solid #444444;
    border-radius: 4px;
    font-size: 12px;
}

.workflow-status.saved {
    color: #27ae60;
    border-color: #27ae60;
}

.workflow-status.unsaved {
    color: #f39c12;
    border-color: #f39c12;
}

.toolbar-btn {
    padding: 4px 10px;
    background: #2a2a2a;
    color: #999999;
    border: 1px solid #3a3a3a;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 5px;
}

.toolbar-btn:hover:not(:disabled) {
    background: #333333;
    border-color: #4a4a4a;
    color: #cccccc;
}

.toolbar-btn.primary {
    background: #3a3a3a;
    color: #cccccc;
    border-color: #4a4a4a;
}

.toolbar-btn.primary:hover:not(:disabled) {
    background: #454545;
    border-color: #555555;
    color: #ffffff;
}

.toolbar-btn:disabled {
    background: #242424;
    color: #555555;
    cursor: not-allowed;
    border-color: #2a2a2a;
}

.toolbar-right {
    display: flex;
    gap: 12px;
    align-items: center;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #cccccc;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #27ae60;
}

.status-dot.locked {
    background: #e74c3c;
    animation: pulse 1.5s infinite;
}

/* ========== è§†å›¾åˆ‡æ¢æŒ‰é’®ç»„ ========== */
.view-toggle-container {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 30;
    display: flex;
    gap: 0;
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 4px;
    padding: 2px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.view-toggle-btn {
    padding: 6px 16px;
    background: transparent;
    border: none;
    color: #999999;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 3px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.view-toggle-btn:hover {
    color: #cccccc;
    background: #333333;
}

.view-toggle-btn.active {
    background: #3a3a3a;
    color: #ffffff;
    border: 1px solid #4a4a4a;
}

/* ========== ComfyUI iframe å®¹å™¨ ========== */
.comfyui-container {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #252525;
}

.comfyui-iframe {
    width: 100%;
    height: 100%;
    border: none;
}

/* ========== JSON è§†å›¾å®¹å™¨ ========== */
.json-view-container {
    width: 100%;
    height: 100%;
    display: none;
    background: #1e1e1e;
    overflow: auto;
    padding: 20px;
}

.json-view-container.active {
    display: block;
}

.json-view-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #3a3a3a;
}

.json-view-title {
    font-size: 14px;
    color: #cccccc;
    font-weight: 500;
}

.json-copy-btn {
    padding: 6px 12px;
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    color: #cccccc;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.json-copy-btn:hover {
    background: #333333;
    border-color: #4a4a4a;
}

.json-content {
    background: #252525;
    border: 1px solid #3a3a3a;
    border-radius: 4px;
    padding: 16px;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 12px;
    line-height: 1.6;
    color: #d4d4d4;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.comfyui-view-container {
    width: 100%;
    height: 100%;
    display: block;
}

.comfyui-view-container.hidden {
    display: none;
}

.comfyui-container.locked::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.3);
    z-index: 10;
    pointer-events: none;
}

.lock-overlay {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(231, 76, 60, 0.95);
    color: white;
    padding: 24px 40px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 500;
    z-index: 20;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    text-align: center;
}

.comfyui-container.locked .lock-overlay {
    display: block;
}

.lock-overlay-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.lock-overlay-text {
    margin-bottom: 8px;
}

.lock-overlay-hint {
    font-size: 12px;
    opacity: 0.9;
}

/* ========== Agent å¯¹è¯æ¡† ========== */
.chat-dialog {
    position: absolute;
    right: 12px;
    bottom: 12px;
    width: 380px;
    height: 520px;
    background: #282828;
    border: 1px solid #3a3a3a;
    border-radius: 4px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    z-index: 200;
    transition: all 0.2s ease;
    resize: both;
    overflow: hidden;
    min-width: 300px;
    min-height: 350px;
    max-width: 700px;
    max-height: 85vh;
}

.chat-dialog.hidden {
    transform: translateY(calc(100% + 40px));
    opacity: 0;
    pointer-events: none;
}

.chat-dialog.minimized {
    height: 48px;
    resize: none;
}

.chat-dialog.minimized .chat-messages,
.chat-dialog.minimized .chat-input-area {
    display: none;
}

.chat-dialog-header {
    background: #242424;
    color: #cccccc;
    padding: 8px 10px;
    border-radius: 4px 4px 0 0;
    border-bottom: 1px solid #3a3a3a;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: move;
    user-select: none;
}

.chat-dialog-title {
    font-size: 12px;
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
    overflow: hidden;
}

.chat-dialog-title-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.chat-dialog-controls {
    display: flex;
    gap: 4px;
}

.chat-control-btn {
    background: transparent;
    border: none;
    color: #777777;
    width: 22px;
    height: 22px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.chat-control-btn:hover {
    background: #3a3a3a;
    color: #cccccc;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    background: #242424;
}

.message {
    margin-bottom: 12px;
    display: flex;
    gap: 8px;
    animation: slideIn 0.2s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    flex-direction: row-reverse;
}

.avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #3a3a3a;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999999;
    font-weight: 500;
    font-size: 11px;
    flex-shrink: 0;
}

.message.user .avatar {
    background: #4a4a4a;
    color: #cccccc;
}

.message-content {
    max-width: 75%;
    background: #2a2a2a;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #3a3a3a;
    font-size: 12px;
    line-height: 1.5;
    color: #cccccc;
}

.message.user .message-content {
    background: #3a3a3a;
    color: #cccccc;
    border-color: #4a4a4a;
}

.workflow-action {
    margin-top: 6px;
    padding: 8px;
    background: #1e1e1e;
    border-radius: 3px;
    font-size: 11px;
    border-left: 2px solid #555555;
}

.workflow-action strong {
    display: block;
    margin-bottom: 4px;
    color: #999999;
}

.chat-input-area {
    padding: 10px;
    background: #242424;
    border-top: 1px solid #3a3a3a;
    border-radius: 0 0 4px 4px;
}

.chat-input-container {
    display: flex;
    gap: 8px;
}

.chat-input-container input {
    flex: 1;
    padding: 6px 10px;
    background: #1e1e1e;
    border: 1px solid #3a3a3a;
    border-radius: 3px;
    font-size: 12px;
    color: #cccccc;
    outline: none;
    transition: border-color 0.15s;
}

.chat-input-container input:focus {
    border-color: #555555;
}

.chat-input-container input::placeholder {
    color: #555555;
}

.chat-send-btn {
    padding: 6px 14px;
    background: #3a3a3a;
    color: #cccccc;
    border: 1px solid #4a4a4a;
    border-radius: 3px;
    cursor: pointer;
    font-weight: 400;
    font-size: 12px;
    transition: all 0.15s;
}

.chat-send-btn:hover {
    background: #454545;
    border-color: #555555;
    color: #ffffff;
}

.chat-send-btn:disabled {
    background: #2a2a2a;
    color: #555555;
    cursor: not-allowed;
    border-color: #333333;
}

/* ========== è°ƒæ•´å¤§å°æŒ‡ç¤ºå™¨ ========== */
.resize-indicator {
    position: absolute;
    right: 0;
    bottom: 0;
    width: 20px;
    height: 20px;
    cursor: nwse-resize;
    opacity: 0.5;
}

.resize-indicator::after {
    content: 'â‹°';
    position: absolute;
    right: 4px;
    bottom: 2px;
    font-size: 14px;
    color: #999999;
}

/* ========== æ»šåŠ¨æ¡æ ·å¼ ========== */
.session-list::-webkit-scrollbar,
.chat-messages::-webkit-scrollbar,
.workflow-dropdown::-webkit-scrollbar {
    width: 6px;
}

.session-list::-webkit-scrollbar-track,
.chat-messages::-webkit-scrollbar-track,
.workflow-dropdown::-webkit-scrollbar-track {
    background: transparent;
}

.session-list::-webkit-scrollbar-thumb {
    background: #444444;
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb,
.workflow-dropdown::-webkit-scrollbar-thumb {
    background: #444444;
    border-radius: 3px;
}

.session-list::-webkit-scrollbar-thumb:hover,
.chat-messages::-webkit-scrollbar-thumb:hover,
.workflow-dropdown::-webkit-scrollbar-thumb:hover {
    background: #555555;
}

/* ========== æ–°å»º/ç¼–è¾‘ä¼šè¯æ¨¡æ€æ¡† ========== */
.session-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.75);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.session-modal-overlay.active {
    display: flex;
}

.session-modal {
    background: #2a2a2a;
    border-radius: 8px;
    width: 90%;
    max-width: 520px;
    border: 1px solid #444444;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
}

.session-modal-header {
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #3a3a3a;
}

.session-modal-title {
    font-size: 16px;
    font-weight: 500;
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.session-modal-close {
    width: 32px;
    height: 32px;
    background: transparent;
    border: none;
    color: #999999;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 20px;
}

.session-modal-close:hover {
    background: #3a3a3a;
    color: #ffffff;
}

.session-modal-body {
    padding: 24px;
    max-height: 60vh;
    overflow-y: auto;
}

.session-form-group {
    margin-bottom: 20px;
}

.session-form-label {
    display: block;
    font-size: 13px;
    color: #cccccc;
    margin-bottom: 8px;
    font-weight: 400;
}

.session-form-label .required {
    color: #e74c3c;
    margin-left: 2px;
}

.session-form-input {
    width: 100%;
    padding: 8px 12px;
    background: #1e1e1e;
    border: 1px solid #3a3a3a;
    border-radius: 4px;
    font-size: 13px;
    color: #cccccc;
    outline: none;
    transition: border-color 0.2s;
}

.session-form-input:focus {
    border-color: #555555;
}

.session-form-input::placeholder {
    color: #555555;
}

.session-form-select {
    width: 100%;
    padding: 8px 12px;
    background: #1e1e1e;
    border: 1px solid #3a3a3a;
    border-radius: 4px;
    font-size: 13px;
    color: #cccccc;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
}

.session-form-select:focus {
    border-color: #555555;
}

.session-form-textarea {
    width: 100%;
    padding: 8px 12px;
    background: #1e1e1e;
    border: 1px solid #3a3a3a;
    border-radius: 4px;
    font-size: 13px;
    color: #cccccc;
    outline: none;
    transition: border-color 0.2s;
    resize: vertical;
    min-height: 100px;
    font-family: 'Consolas', 'Monaco', monospace;
}

.session-form-textarea:focus {
    border-color: #555555;
}

.session-form-textarea::placeholder {
    color: #555555;
}

.session-form-hint {
    font-size: 11px;
    color: #777777;
    margin-top: 6px;
}

.session-modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #3a3a3a;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.session-modal-btn {
    padding: 8px 20px;
    border: 1px solid #3a3a3a;
    border-radius: 4px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.session-modal-btn-cancel {
    background: transparent;
    color: #cccccc;
}

.session-modal-btn-cancel:hover {
    background: #3a3a3a;
    border-color: #4a4a4a;
}

.session-modal-btn-save {
    background: #3a3a3a;
    color: #ffffff;
    border-color: #4a4a4a;
}

.session-modal-btn-save:hover {
    background: #454545;
    border-color: #555555;
}

/* ========== ä¼šè¯é¡¹ç¼–è¾‘æŒ‰é’® ========== */
.session-item-actions {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0;
    transition: opacity 0.2s;
}

.session-item:hover .session-item-actions {
    opacity: 1;
}

.session-edit-btn {
    width: 24px;
    height: 24px;
    background: transparent;
    border: none;
    color: #777777;
    cursor: pointer;
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.session-edit-btn:hover {
    background: #3a3a3a;
    color: #cccccc;
}

/* ========== å“åº”å¼ ========== */
@media (max-width: 1024px) {
    .session-sidebar {
        width: 260px;
    }

    .chat-dialog {
        width: 360px;
        height: 500px;
    }

    .session-modal {
        max-width: 90%;
    }
}

@media (max-width: 768px) {
    .session-sidebar {
        position: absolute;
        left: -300px;
        height: 100%;
        transition: left 0.3s;
        z-index: 300;
    }

    .session-sidebar.mobile-open {
        left: 0;
    }

    .chat-dialog {
        width: calc(100% - 40px);
        max-width: 400px;
        right: 20px;
        bottom: 20px;
    }
}
</style>
</head>
<body>
<!-- SVG å›¾æ ‡å®šä¹‰ -->
<svg style="display: none;">
    <!-- æœåŠ¡å™¨å›¾æ ‡ -->
    <symbol id="icon-server" viewBox="0 0 24 24">
        <path d="M20 13H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-6c0-.55-.45-1-1-1zM7 19c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM20 3H4c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h16c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1zM7 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
    </symbol>

    <!-- æ¶ˆæ¯å›¾æ ‡ -->
    <symbol id="icon-message" viewBox="0 0 24 24">
        <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>
    </symbol>

    <!-- æ·»åŠ å›¾æ ‡ -->
    <symbol id="icon-add" viewBox="0 0 24 24">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
    </symbol>

    <!-- å·¥ä½œæµå›¾æ ‡ -->
    <symbol id="icon-workflow" viewBox="0 0 24 24">
        <path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/>
    </symbol>

    <!-- æ—¶é’Ÿå›¾æ ‡ -->
    <symbol id="icon-clock" viewBox="0 0 24 24">
        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
    </symbol>

    <!-- è¿”å›ç®­å¤´å›¾æ ‡ -->
    <symbol id="icon-arrow-back" viewBox="0 0 24 24">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
    </symbol>

    <!-- ä¿å­˜å›¾æ ‡ -->
    <symbol id="icon-save" viewBox="0 0 24 24">
        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
    </symbol>

    <!-- å¯¼å‡ºå›¾æ ‡ -->
    <symbol id="icon-export" viewBox="0 0 24 24">
        <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
    </symbol>

    <!-- ä¸‹æ‹‰ç®­å¤´å›¾æ ‡ -->
    <symbol id="icon-arrow-down" viewBox="0 0 24 24">
        <path d="M7 10l5 5 5-5z"/>
    </symbol>

    <!-- é”å›¾æ ‡ -->
    <symbol id="icon-lock" viewBox="0 0 24 24">
        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
    </symbol>

    <!-- æ£€æŸ¥å›¾æ ‡ -->
    <symbol id="icon-check" viewBox="0 0 24 24">
        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </symbol>

    <!-- è­¦å‘Šå›¾æ ‡ -->
    <symbol id="icon-warning" viewBox="0 0 24 24">
        <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
    </symbol>

    <!-- ç¼–è¾‘å›¾æ ‡ -->
    <symbol id="icon-edit" viewBox="0 0 24 24">
        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
    </symbol>

    <!-- ä»£ç å›¾æ ‡ -->
    <symbol id="icon-code" viewBox="0 0 24 24">
        <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
    </symbol>

    <!-- è§†å›¾å›¾æ ‡ -->
    <symbol id="icon-view" viewBox="0 0 24 24">
        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
    </symbol>

    <!-- å¤åˆ¶å›¾æ ‡ -->
    <symbol id="icon-copy" viewBox="0 0 24 24">
        <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </symbol>
</svg>

<!-- å·¦ä¾§ä¼šè¯ç®¡ç†åŒºåŸŸ -->
<div class="session-sidebar">
    <div class="session-header">
        <h2 class="session-header-title">
            <svg class="icon icon-lg">
                <use href="#icon-message"></use>
            </svg>
            <span>Agent ä¼šè¯</span>
        </h2>
        <button class="new-session-btn" onclick="createNewSession()">
            <svg class="icon">
                <use href="#icon-add"></use>
            </svg>
            <span>æ–°å»ºä¼šè¯</span>
        </button>
    </div>
    <div class="session-list" id="sessionList">
        <!-- ä¼šè¯åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div class="session-footer">
        <button class="back-btn" onclick="goBack()">
            <svg class="icon">
                <use href="#icon-arrow-back"></use>
            </svg>
            <span>è¿”å›æœåŠ¡é€‰æ‹©</span>
        </button>
    </div>
</div>

<!-- ä¸»å·¥ä½œåŒºåŸŸ -->
<div class="main-workspace">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <button class="logo-btn" onclick="goHome()" title="è¿”å›é¦–é¡µ">
                <svg class="icon icon-lg">
                    <use href="#icon-server"></use>
                </svg>
                <span>ComfyUI Agent</span>
            </button>
            <button class="toolbar-btn" onclick="createNewWorkflow()" title="æ–°å»ºå·¥ä½œæµ">
                <svg class="icon">
                    <use href="#icon-add"></use>
                </svg>
                <span>æ–°å»º</span>
            </button>
            <button class="toolbar-btn" onclick="importWorkflow()" title="å¯¼å…¥å·¥ä½œæµ">
                <svg class="icon">
                    <use href="#icon-export"></use>
                </svg>
                <span>å¯¼å…¥</span>
            </button>
            <div class="workflow-selector" id="workflowSelector">
                <button class="workflow-select-btn" onclick="toggleWorkflowDropdown()">
                    <svg class="icon">
                        <use href="#icon-workflow"></use>
                    </svg>
                    <span id="currentWorkflowName">SDXL å›¾åƒç”Ÿæˆ</span>
                    <svg class="icon">
                        <use href="#icon-arrow-down"></use>
                    </svg>
                </button>
                <div class="workflow-dropdown" id="workflowDropdown">
                    <!-- å·¥ä½œæµåˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <div class="service-indicator">
                <span class="service-dot"></span>
                <span>ç”Ÿäº§ç¯å¢ƒ ComfyUI</span>
            </div>
            <div class="workflow-status saved" id="workflowStatus">
                <svg class="icon">
                    <use href="#icon-check"></use>
                </svg>
                <span id="workflowStatusText">å·²ä¿å­˜</span>
            </div>
            <button class="toolbar-btn primary" id="saveBtn" onclick="saveWorkflow()">
                <svg class="icon">
                    <use href="#icon-save"></use>
                </svg>
                <span>ä¿å­˜ (Ctrl+S)</span>
            </button>
            <button class="toolbar-btn" onclick="exportWorkflow()">
                <svg class="icon">
                    <use href="#icon-export"></use>
                </svg>
                <span>å¯¼å‡º</span>
            </button>
        </div>
        <div class="toolbar-right">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">å°±ç»ª</span>
            </div>
        </div>
    </div>

    <!-- ComfyUI iframe å®¹å™¨ -->
    <div class="comfyui-container" id="comfyuiContainer">
        <!-- è§†å›¾åˆ‡æ¢æŒ‰é’®ç»„ -->
        <div class="view-toggle-container">
            <button class="view-toggle-btn active" id="comfyuiViewBtn" onclick="switchView('comfyui')">
                <svg class="icon">
                    <use href="#icon-view"></use>
                </svg>
                <span>ComfyUI è§†å›¾</span>
            </button>
            <button class="view-toggle-btn" id="jsonViewBtn" onclick="switchView('json')">
                <svg class="icon">
                    <use href="#icon-code"></use>
                </svg>
                <span>JSON åŸå‹</span>
            </button>
        </div>

        <!-- ComfyUI è§†å›¾å®¹å™¨ -->
        <div class="comfyui-view-container" id="comfyuiView">
            <!-- å®é™…é¡¹ç›®ä¸­ä½¿ç”¨: <iframe class="comfyui-iframe" src="http://192.168.1.100:8188" id="comfyuiFrame"></iframe> -->

            <!-- æ¼”ç¤ºç”¨ï¼šæ¨¡æ‹Ÿ ComfyUI ç•Œé¢ -->
            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999999; font-size: 16px; flex-direction: column; gap: 16px;">
                <svg class="icon" style="width: 64px; height: 64px; fill: #666666;">
                    <use href="#icon-workflow"></use>
                </svg>
                <div>ComfyUI å·¥ä½œæµç¼–è¾‘å™¨</div>
                <div style="font-size: 13px; opacity: 0.7;">å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šåµŒå…¥ ComfyUI iframe</div>
                <div style="font-size: 12px; font-family: monospace; background: #353535; padding: 8px 16px; border-radius: 4px; color: #cccccc; border: 1px solid #444444;">
                    &lt;iframe src="http://192.168.1.100:8188"&gt;&lt;/iframe&gt;
                </div>
            </div>
        </div>

        <!-- JSON è§†å›¾å®¹å™¨ -->
        <div class="json-view-container" id="jsonView">
            <div class="json-view-header">
                <div class="json-view-title">å·¥ä½œæµ JSON åŸå‹</div>
                <button class="json-copy-btn" onclick="copyJsonToClipboard()">
                    <svg class="icon">
                        <use href="#icon-copy"></use>
                    </svg>
                    <span>å¤åˆ¶ JSON</span>
                </button>
            </div>
            <div class="json-content" id="jsonContent">
                <!-- JSON å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é”å®šé®ç½© -->
        <div class="lock-overlay">
            <div class="lock-overlay-icon">
                <svg class="icon" style="width: 48px; height: 48px;">
                    <use href="#icon-lock"></use>
                </svg>
            </div>
            <div class="lock-overlay-text">Agent æ­£åœ¨ç¼–è¾‘å·¥ä½œæµ...</div>
            <div class="lock-overlay-hint">è¯·ç¨å€™ï¼Œç¼–è¾‘å®Œæˆåå°†è‡ªåŠ¨è§£é”</div>
        </div>
    </div>

    <!-- æ‚¬æµ® Agent å¯¹è¯æ¡† -->
    <div class="chat-dialog" id="chatDialog">
        <div class="chat-dialog-header" id="chatHeader">
            <div class="chat-dialog-title">
                <svg class="icon">
                    <use href="#icon-message"></use>
                </svg>
                <span class="chat-dialog-title-text" id="chatSessionName">SDXL å›¾åƒç”Ÿæˆå·¥ä½œæµ</span>
            </div>
            <div class="chat-dialog-controls">
                <button class="chat-control-btn" onclick="toggleMinimize()" title="æœ€å°åŒ–/è¿˜åŸ">âˆ’</button>
                <button class="chat-control-btn" onclick="closeChat()" title="å…³é—­">Ã—</button>
            </div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- æ¶ˆæ¯å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="chat-input-area">
            <div class="chat-input-container">
                <input type="text" id="chatInput" placeholder="è¾“å…¥ä½ çš„éœ€æ±‚..." onkeypress="handleChatKeyPress(event)" />
                <button class="chat-send-btn" onclick="sendMessage()">å‘é€</button>
            </div>
        </div>
        <div class="resize-indicator"></div>
    </div>
</div>

<!-- æ–°å»º/ç¼–è¾‘ä¼šè¯æ¨¡æ€æ¡† -->
<div class="session-modal-overlay" id="sessionModal" onclick="closeSessionModal()">
    <div class="session-modal" onclick="event.stopPropagation()">
        <div class="session-modal-header">
            <h3 class="session-modal-title">
                <svg class="icon icon-lg">
                    <use href="#icon-message"></use>
                </svg>
                <span id="sessionModalTitle">æ–°å»ºä¼šè¯</span>
            </h3>
            <button class="session-modal-close" onclick="closeSessionModal()">Ã—</button>
        </div>
        <div class="session-modal-body">
            <form id="sessionForm">
                <div class="session-form-group">
                    <label class="session-form-label">
                        å¯¹è¯åç§°<span class="required">*</span>
                    </label>
                    <input
                        type="text"
                        class="session-form-input"
                        id="sessionName"
                        placeholder="å¯¹è¯ #1"
                        required
                    >
                    <div class="session-form-hint">é»˜è®¤æ ¼å¼ï¼šå¯¹è¯ #xï¼Œx ä¸ºè‡ªåŠ¨é€’å¢ç¼–å·</div>
                </div>

                <div class="session-form-group">
                    <label class="session-form-label">
                        é€‰æ‹© Agent<span class="required">*</span>
                    </label>
                    <select class="session-form-select" id="sessionAgent" required>
                        <option value="">è¯·é€‰æ‹© Agent</option>
                        <option value="workflow_editor">å·¥ä½œæµç¼–è¾‘å™¨ (WORKFLOW_EDITOR)</option>
                        <option value="workflow_analyzer">å·¥ä½œæµåˆ†æå™¨ (WORKFLOW_ANALYZER)</option>
                        <option value="general_assistant">é€šç”¨åŠ©æ‰‹ (GENERAL_ASSISTANT)</option>
                    </select>
                    <div class="session-form-hint">Agent åœ¨ç®¡ç†å‘˜åå°é…ç½®æ¨¡å—ä¸­ç®¡ç†</div>
                </div>

                <div class="session-form-group">
                    <label class="session-form-label">
                        Rules æ–‡ä»¶
                    </label>
                    <textarea
                        class="session-form-textarea"
                        id="sessionRules"
                        placeholder="# Rules for this session&#10;&#10;åœ¨æ­¤è¾“å…¥å¯¹è¯çš„ Rules è§„åˆ™...&#10;&#10;ç¤ºä¾‹ï¼š&#10;- ä½¿ç”¨ä¸­æ–‡å›å¤&#10;- ä¸“æ³¨äºå·¥ä½œæµç¼–è¾‘ä»»åŠ¡&#10;- æä¾›è¯¦ç»†çš„æ“ä½œæ­¥éª¤"
                    ></textarea>
                    <div class="session-form-hint">å¯é€‰ï¼šä¸ºæ­¤å¯¹è¯è®¾ç½®ç‰¹å®šçš„ Rules è§„åˆ™</div>
                </div>
            </form>
        </div>
        <div class="session-modal-footer">
            <button class="session-modal-btn session-modal-btn-cancel" onclick="closeSessionModal()">
                å–æ¶ˆ
            </button>
            <button class="session-modal-btn session-modal-btn-save" onclick="saveSession()">
                <svg class="icon">
                    <use href="#icon-save"></use>
                </svg>
                <span>ä¿å­˜</span>
            </button>
        </div>
    </div>
</div>

<script>
// ========== å…¨å±€çŠ¶æ€ ==========
let isWorkflowLocked = false;
let currentSessionId = 1;
let isChatOpen = true;
let isChatMinimized = false;
let hasUnsavedChanges = false;
let currentWorkflowName = 'SDXL å›¾åƒç”Ÿæˆ';
let currentWorkflowId = 1;
let currentView = 'comfyui'; // 'comfyui' æˆ– 'json'

// ========== å·¥ä½œæµæ•°æ® ==========
const workflows = [
    { id: 1, name: 'SDXL å›¾åƒç”Ÿæˆ', sessions: 5, versions: 12, lastUsed: '2 å°æ—¶å‰' },
    { id: 2, name: 'ControlNet å§¿æ€æ§åˆ¶', sessions: 3, versions: 8, lastUsed: '1 å¤©å‰' },
    { id: 3, name: 'è§†é¢‘å¸§æ’å€¼', sessions: 2, versions: 5, lastUsed: '3 å¤©å‰' },
    { id: 4, name: 'å›¾åƒè¶…åˆ†è¾¨ç‡', sessions: 4, versions: 10, lastUsed: '5 å¤©å‰' }
];

// ========== ç¤ºä¾‹å·¥ä½œæµ JSON æ•°æ® ==========
const workflowJsonData = {
    "nodes": [
        {
            "id": 1,
            "type": "CheckpointLoaderSimple",
            "pos": [50, 100],
            "size": [315, 98],
            "flags": {},
            "order": 0,
            "mode": 0,
            "outputs": [
                {"name": "MODEL", "type": "MODEL", "links": [1]},
                {"name": "CLIP", "type": "CLIP", "links": [2, 3]},
                {"name": "VAE", "type": "VAE", "links": [4]}
            ],
            "properties": {},
            "widgets_values": ["sd_xl_base_1.0.safetensors"]
        },
        {
            "id": 2,
            "type": "CLIPTextEncode",
            "pos": [400, 50],
            "size": [400, 200],
            "flags": {},
            "order": 1,
            "mode": 0,
            "inputs": [
                {"name": "clip", "type": "CLIP", "link": 2}
            ],
            "outputs": [
                {"name": "CONDITIONING", "type": "CONDITIONING", "links": [5]}
            ],
            "properties": {},
            "widgets_values": ["a beautiful landscape"]
        },
        {
            "id": 3,
            "type": "CLIPTextEncode",
            "pos": [400, 300],
            "size": [400, 200],
            "flags": {},
            "order": 2,
            "mode": 0,
            "inputs": [
                {"name": "clip", "type": "CLIP", "link": 3}
            ],
            "outputs": [
                {"name": "CONDITIONING", "type": "CONDITIONING", "links": [6]}
            ],
            "properties": {},
            "widgets_values": ["text, watermark"]
        }
    ],
    "connections": [
        {"id": 1, "origin_id": 1, "origin_slot": 0, "target_id": 4, "target_slot": 0},
        {"id": 2, "origin_id": 1, "origin_slot": 1, "target_id": 2, "target_slot": 0},
        {"id": 3, "origin_id": 1, "origin_slot": 1, "target_id": 3, "target_slot": 0}
    ],
    "metadata": {
        "name": "SDXL å›¾åƒç”Ÿæˆå·¥ä½œæµ",
        "version": "1.0",
        "description": "åŸºç¡€çš„ SDXL å›¾åƒç”Ÿæˆå·¥ä½œæµ"
    }
};

// ========== ä¼šè¯æ•°æ® ==========
const sessions = [
    {
        id: 1,
        title: 'å¯¹è¯ #1 (è¿›è¡Œä¸­)',
        workflowName: 'SDXL å›¾åƒç”Ÿæˆ',
        summary: 'æ·»åŠ äº† ControlNet èŠ‚ç‚¹',
        time: '5 åˆ†é’Ÿå‰',
        active: true,
        agent: 'workflow_editor',
        rules: '# Rules for Session #1\n- ä½¿ç”¨ä¸­æ–‡å›å¤\n- ä¸“æ³¨äºå·¥ä½œæµç¼–è¾‘ä»»åŠ¡'
    },
    {
        id: 2,
        title: 'å¯¹è¯ #2',
        workflowName: 'SDXL å›¾åƒç”Ÿæˆ',
        summary: 'ä¼˜åŒ–äº†é‡‡æ ·å‚æ•°',
        time: '1 å°æ—¶å‰',
        active: false,
        agent: 'workflow_analyzer',
        rules: ''
    },
    {
        id: 3,
        title: 'å¯¹è¯ #3',
        workflowName: 'ControlNet å§¿æ€æ§åˆ¶',
        summary: 'ä»…å’¨è¯¢ï¼Œæ— ä¿®æ”¹',
        time: 'æ˜¨å¤©',
        active: false,
        agent: 'general_assistant',
        rules: ''
    }
];

// ========== åˆå§‹åŒ–æ¸²æŸ“ ==========
function renderSessionList() {
    const sessionList = document.getElementById('sessionList');
    sessionList.innerHTML = sessions.map(session => `
        <div class="session-item ${session.active ? 'active' : ''}" onclick="switchSession(${session.id})">
            <div class="session-item-header">
                <span class="session-status-dot ${session.active ? '' : 'idle'}"></span>
                <span class="session-item-title">${session.title}</span>
            </div>
            <div class="session-item-meta">
                <div class="session-meta-row">
                    <svg class="icon">
                        <use href="#icon-workflow"></use>
                    </svg>
                    <span>${session.workflowName}</span>
                </div>
                <div class="session-meta-row">
                    <svg class="icon">
                        <use href="#icon-check"></use>
                    </svg>
                    <span>${session.summary}</span>
                </div>
                <div class="session-meta-row">
                    <svg class="icon">
                        <use href="#icon-clock"></use>
                    </svg>
                    <span>${session.time}</span>
                </div>
            </div>
            <div class="session-item-actions">
                <button class="session-edit-btn" onclick="event.stopPropagation(); editSession(${session.id})" title="ç¼–è¾‘ä¼šè¯">
                    <svg class="icon">
                        <use href="#icon-edit"></use>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

function renderWorkflowDropdown() {
    const dropdown = document.getElementById('workflowDropdown');
    dropdown.innerHTML = workflows.map(wf => `
        <div class="workflow-dropdown-item ${wf.id === currentWorkflowId ? 'active' : ''}"
             onclick="selectWorkflow(${wf.id})">
            <div class="workflow-item-name">${wf.name}</div>
            <div class="workflow-item-meta">
                <svg class="icon">
                    <use href="#icon-message"></use>
                </svg>
                <span>${wf.sessions} ä¼šè¯</span>
                <span>Â·</span>
                <svg class="icon">
                    <use href="#icon-clock"></use>
                </svg>
                <span>${wf.lastUsed}</span>
            </div>
        </div>
    `).join('');
}

function renderInitialMessages() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = `
        <div class="message">
            <div class="avatar">AI</div>
            <div class="message-content">
                ä½ å¥½ï¼æˆ‘æ˜¯ ComfyUI å·¥ä½œæµåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®ä½ åˆ›å»ºå’Œç¼–è¾‘å·¥ä½œæµã€‚ä½ æƒ³åšä»€ä¹ˆï¼Ÿ
            </div>
        </div>
        <div class="message user">
            <div class="avatar">U</div>
            <div class="message-content">
                æˆ‘æƒ³åˆ›å»ºä¸€ä¸ª SDXL å›¾åƒç”Ÿæˆå·¥ä½œæµ
            </div>
        </div>
        <div class="message">
            <div class="avatar">AI</div>
            <div class="message-content">
                å¥½çš„ï¼æˆ‘å·²ç»ä¸ºä½ åˆ›å»ºäº†åŸºç¡€çš„ SDXL å·¥ä½œæµï¼ŒåŒ…å«ä»¥ä¸‹èŠ‚ç‚¹ï¼š
                <div class="workflow-action">
                    <strong>âœ… å·¥ä½œæµå·²åˆ›å»ºï¼š</strong>
                    1. CheckpointLoader (SDXL æ¨¡å‹)<br>
                    2. CLIPTextEncode (æ­£å‘/è´Ÿå‘æç¤ºè¯)<br>
                    3. KSampler (é‡‡æ ·å™¨)<br>
                    4. VAEDecode + SaveImage
                </div>
                ä½ æƒ³ä¿®æ”¹å“ªäº›å‚æ•°æˆ–æ·»åŠ æ–°èŠ‚ç‚¹å—ï¼Ÿ
            </div>
        </div>
    `;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ========== å·¥ä½œæµé€‰æ‹©å™¨ ==========
function toggleWorkflowDropdown() {
    const selector = document.getElementById('workflowSelector');
    selector.classList.toggle('active');
}

function selectWorkflow(workflowId) {
    if (hasUnsavedChanges) {
        if (!confirm('âš ï¸ æœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\nåˆ‡æ¢å·¥ä½œæµå°†ä¸¢å¤±æœªä¿å­˜çš„ä¿®æ”¹\n\nç¡®å®šè¦åˆ‡æ¢å—ï¼Ÿ')) {
            return;
        }
    }

    currentWorkflowId = workflowId;
    const workflow = workflows.find(w => w.id === workflowId);
    if (workflow) {
        currentWorkflowName = workflow.name;
        document.getElementById('currentWorkflowName').textContent = workflow.name;
        hasUnsavedChanges = false;
        updateWorkflowStatus();
        renderWorkflowDropdown();
    }

    toggleWorkflowDropdown();
}

// ç‚¹å‡»å¤–éƒ¨å…³é—­å·¥ä½œæµä¸‹æ‹‰èœå•
document.addEventListener('click', function(event) {
    const selector = document.getElementById('workflowSelector');
    if (selector && !selector.contains(event.target)) {
        selector.classList.remove('active');
    }
});

// ========== å·¥ä½œæµä¿å­˜ç®¡ç† ==========
function createNewWorkflow() {
    if (hasUnsavedChanges) {
        if (!confirm('âš ï¸ æœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\nåˆ›å»ºæ–°å·¥ä½œæµå°†ä¸¢å¤±æœªä¿å­˜çš„ä¿®æ”¹\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
            return;
        }
    }

    const workflowName = prompt('è¯·è¾“å…¥æ–°å·¥ä½œæµåç§°ï¼š', 'æ–°å·¥ä½œæµ');
    if (workflowName && workflowName.trim()) {
        console.log('åˆ›å»ºæ–°å·¥ä½œæµ:', workflowName);
        alert('âœ… å·²åˆ›å»ºæ–°å·¥ä½œæµï¼š' + workflowName);
        // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šè°ƒç”¨ API åˆ›å»ºå·¥ä½œæµ
    }
}

function importWorkflow() {
    if (hasUnsavedChanges) {
        if (!confirm('âš ï¸ æœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\nå¯¼å…¥å·¥ä½œæµå°†ä¸¢å¤±æœªä¿å­˜çš„ä¿®æ”¹\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
            return;
        }
    }

    alert('ğŸ“¥ å¯¼å…¥å·¥ä½œæµåŠŸèƒ½\n\nè¯·é€‰æ‹©è¦å¯¼å…¥çš„å·¥ä½œæµ JSON æ–‡ä»¶');
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šæ‰“å¼€æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
}

function saveWorkflow() {
    if (!hasUnsavedChanges) {
        alert('ğŸ’¡ å·¥ä½œæµæ²¡æœ‰ä¿®æ”¹ï¼Œæ— éœ€ä¿å­˜');
        return;
    }

    console.log('ä¿å­˜å·¥ä½œæµ:', currentWorkflowName);
    hasUnsavedChanges = false;
    updateWorkflowStatus();
    alert('âœ… å·¥ä½œæµå·²ä¿å­˜ï¼');
}

function exportWorkflow() {
    alert('ğŸ“¤ å¯¼å‡ºå·¥ä½œæµåŠŸèƒ½\n\nå°†å¯¼å‡ºå½“å‰å·¥ä½œæµä¸º JSON æ–‡ä»¶');
}

function markAsUnsaved() {
    hasUnsavedChanges = true;
    updateWorkflowStatus();
}

function updateWorkflowStatus() {
    const statusElement = document.getElementById('workflowStatus');
    const statusTextElement = document.getElementById('workflowStatusText');

    if (hasUnsavedChanges) {
        statusElement.classList.remove('saved');
        statusElement.classList.add('unsaved');
        statusElement.innerHTML = `
            <svg class="icon">
                <use href="#icon-warning"></use>
            </svg>
            <span id="workflowStatusText">æœ‰æœªä¿å­˜çš„ä¿®æ”¹</span>
        `;
    } else {
        statusElement.classList.remove('unsaved');
        statusElement.classList.add('saved');
        statusElement.innerHTML = `
            <svg class="icon">
                <use href="#icon-check"></use>
            </svg>
            <span id="workflowStatusText">å·²ä¿å­˜</span>
        `;
    }
}

// ========== ä¼šè¯ç®¡ç† ==========
let editingSessionId = null; // ç”¨äºè·Ÿè¸ªå½“å‰ç¼–è¾‘çš„ä¼šè¯ID

// æ‰“å¼€æ–°å»ºä¼šè¯æ¨¡æ€æ¡†
function createNewSession() {
    editingSessionId = null;
    document.getElementById('sessionModalTitle').textContent = 'æ–°å»ºä¼šè¯';

    // ç”Ÿæˆé»˜è®¤ä¼šè¯åç§°
    const maxSessionNumber = sessions.reduce((max, s) => {
        const match = s.title.match(/å¯¹è¯ #(\d+)/);
        return match ? Math.max(max, parseInt(match[1])) : max;
    }, 0);
    const defaultName = `å¯¹è¯ #${maxSessionNumber + 1}`;

    // é‡ç½®è¡¨å•
    document.getElementById('sessionName').value = defaultName;
    document.getElementById('sessionAgent').value = '';
    document.getElementById('sessionRules').value = '';

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('sessionModal').classList.add('active');
}

// æ‰“å¼€ç¼–è¾‘ä¼šè¯æ¨¡æ€æ¡†
function editSession(sessionId) {
    editingSessionId = sessionId;
    const session = sessions.find(s => s.id === sessionId);

    if (!session) return;

    document.getElementById('sessionModalTitle').textContent = 'ç¼–è¾‘ä¼šè¯';
    document.getElementById('sessionName').value = session.title;
    document.getElementById('sessionAgent').value = session.agent || '';
    document.getElementById('sessionRules').value = session.rules || '';

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('sessionModal').classList.add('active');
}

// å…³é—­ä¼šè¯æ¨¡æ€æ¡†
function closeSessionModal() {
    document.getElementById('sessionModal').classList.remove('active');
    editingSessionId = null;
}

// ä¿å­˜ä¼šè¯
function saveSession() {
    const name = document.getElementById('sessionName').value.trim();
    const agent = document.getElementById('sessionAgent').value;
    const rules = document.getElementById('sessionRules').value.trim();

    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!name) {
        alert('âŒ è¯·è¾“å…¥å¯¹è¯åç§°');
        return;
    }

    if (!agent) {
        alert('âŒ è¯·é€‰æ‹© Agent');
        return;
    }

    if (editingSessionId) {
        // ç¼–è¾‘ç°æœ‰ä¼šè¯
        const session = sessions.find(s => s.id === editingSessionId);
        if (session) {
            session.title = name;
            session.agent = agent;
            session.rules = rules;
            alert('âœ… ä¼šè¯å·²æ›´æ–°ï¼');
        }
    } else {
        // åˆ›å»ºæ–°ä¼šè¯
        const newSession = {
            id: sessions.length + 1,
            title: name,
            workflowName: currentWorkflowName,
            summary: 'æ–°å»ºä¼šè¯',
            time: 'åˆšåˆš',
            active: false,
            agent: agent,
            rules: rules
        };
        sessions.push(newSession);
        alert('âœ… ä¼šè¯å·²åˆ›å»ºï¼');
    }

    // åˆ·æ–°ä¼šè¯åˆ—è¡¨
    renderSessionList();

    // å…³é—­æ¨¡æ€æ¡†
    closeSessionModal();
}

function switchSession(sessionId) {
    if (hasUnsavedChanges) {
        const confirmed = confirm('âš ï¸ æœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\nå½“å‰å·¥ä½œæµæœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\n[ç¡®å®š] ä¿å­˜å¹¶åˆ‡æ¢\n[å–æ¶ˆ] æ”¾å¼ƒä¿®æ”¹å¹¶åˆ‡æ¢');
        if (confirmed) {
            saveWorkflow();
        } else {
            hasUnsavedChanges = false;
            updateWorkflowStatus();
        }
    }

    currentSessionId = sessionId;

    // æ›´æ–°ä¼šè¯åˆ—è¡¨æ¿€æ´»çŠ¶æ€
    sessions.forEach(s => s.active = s.id === sessionId);
    renderSessionList();

    // æ›´æ–°å¯¹è¯æ¡†æ ‡é¢˜
    const session = sessions.find(s => s.id === sessionId);
    if (session) {
        document.getElementById('chatSessionName').textContent = session.title;
    }

    // æ‰“å¼€å¯¹è¯æ¡†ï¼ˆå¦‚æœå·²å…³é—­ï¼‰
    if (!isChatOpen) {
        openChat();
    }

    // åŠ è½½å¯¹åº”ä¼šè¯çš„æ¶ˆæ¯
    loadSessionMessages(sessionId);
}

function loadSessionMessages(sessionId) {
    const messagesContainer = document.getElementById('chatMessages');

    // ç¤ºä¾‹ï¼šä¸åŒä¼šè¯æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
    if (sessionId === 2) {
        messagesContainer.innerHTML = `
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    ä½ å¥½ï¼æˆ‘å¯ä»¥å¸®ä½ ä¼˜åŒ–å·¥ä½œæµå‚æ•°ã€‚
                </div>
            </div>
            <div class="message user">
                <div class="avatar">U</div>
                <div class="message-content">
                    å¸®æˆ‘ä¼˜åŒ–ä¸€ä¸‹é‡‡æ ·å‚æ•°
                </div>
            </div>
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    å¥½çš„ï¼æˆ‘å·²ç»ä¼˜åŒ–äº†é‡‡æ ·å‚æ•°ã€‚
                    <div class="workflow-action">
                        <strong>âœ… å·¥ä½œæµå·²æ›´æ–°ï¼š</strong>
                        è°ƒæ•´äº† KSampler çš„ steps å’Œ cfg å‚æ•°
                    </div>
                </div>
            </div>
        `;
    } else if (sessionId === 3) {
        messagesContainer.innerHTML = `
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
                </div>
            </div>
            <div class="message user">
                <div class="avatar">U</div>
                <div class="message-content">
                    ControlNet çš„æƒé‡åº”è¯¥è®¾ç½®å¤šå°‘ï¼Ÿ
                </div>
            </div>
            <div class="message">
                <div class="avatar">AI</div>
                <div class="message-content">
                    ä¸€èˆ¬å»ºè®®è®¾ç½®åœ¨ 0.5-1.0 ä¹‹é—´ï¼Œå…·ä½“å–å†³äºä½ çš„éœ€æ±‚ã€‚
                </div>
            </div>
        `;
    } else {
        renderInitialMessages();
    }

    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ========== å¯¹è¯æ¡†æ§åˆ¶ ==========
function closeChat() {
    document.getElementById('chatDialog').classList.add('hidden');
    isChatOpen = false;
}

function openChat() {
    document.getElementById('chatDialog').classList.remove('hidden');
    document.getElementById('chatDialog').classList.remove('minimized');
    isChatOpen = true;
    isChatMinimized = false;
}

function toggleMinimize() {
    const chatDialog = document.getElementById('chatDialog');
    isChatMinimized = !isChatMinimized;
    chatDialog.classList.toggle('minimized', isChatMinimized);
}

// ========== å·¥ä½œæµé”å®šæœºåˆ¶ ==========
function lockWorkflow() {
    isWorkflowLocked = true;
    document.getElementById('comfyuiContainer').classList.add('locked');
    document.getElementById('saveBtn').disabled = true;
    document.getElementById('statusDot').classList.add('locked');
    document.getElementById('statusText').textContent = 'Agent ç¼–è¾‘ä¸­';
}

function unlockWorkflow() {
    isWorkflowLocked = false;
    document.getElementById('comfyuiContainer').classList.remove('locked');
    document.getElementById('saveBtn').disabled = false;
    document.getElementById('statusDot').classList.remove('locked');
    document.getElementById('statusText').textContent = 'å°±ç»ª';
}

// ========== æ¶ˆæ¯å‘é€ ==========
function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();

    if (!message) return;

    addMessage('user', message);
    input.value = '';

    // æ¨¡æ‹Ÿ Agent å“åº”
    setTimeout(() => {
        simulateAgentResponse(message);
    }, 1000);
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function addMessage(type, content) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;

    const avatar = type === 'user' ? 'U' : 'AI';
    messageDiv.innerHTML = `
        <div class="avatar">${avatar}</div>
        <div class="message-content">${content}</div>
    `;

    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ========== Agent å“åº”æ¨¡æ‹Ÿ ==========
function simulateAgentResponse(userMessage) {
    const lowerMessage = userMessage.toLowerCase();

    if (lowerMessage.includes('æ·»åŠ ') || lowerMessage.includes('ä¿®æ”¹') || lowerMessage.includes('ç¼–è¾‘')) {
        // æ¨¡æ‹Ÿ Agent ç¼–è¾‘å·¥ä½œæµ
        lockWorkflow();

        addMessage('agent', `
            å¥½çš„ï¼Œæˆ‘æ­£åœ¨ç¼–è¾‘å·¥ä½œæµ...
            <div class="workflow-action">
                <strong>ğŸ”§ æ­£åœ¨æ‰§è¡Œæ“ä½œï¼š</strong>
                ${userMessage}
            </div>
        `);

        // 3ç§’åè§£é”å¹¶æ ‡è®°ä¸ºæœªä¿å­˜
        setTimeout(() => {
            unlockWorkflow();
            markAsUnsaved();
            addMessage('agent', `
                âœ… å·¥ä½œæµå·²æ›´æ–°å®Œæˆï¼
                <div class="workflow-action">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>
                    å·¥ä½œæµå·²ä¿®æ”¹ï¼Œè®°å¾—ä¿å­˜ (Ctrl+S)
                </div>
            `);
        }, 3000);
    } else {
        addMessage('agent', `æ”¶åˆ°ä½ çš„æ¶ˆæ¯ï¼š"${userMessage}"ã€‚æˆ‘è¯¥å¦‚ä½•å¸®åŠ©ä½ ï¼Ÿ`);
    }
}

// ========== å¯¹è¯æ¡†æ‹–åŠ¨åŠŸèƒ½ ==========
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;

chatHeader.addEventListener('mousedown', function(e) {
    if (e.target.closest('.chat-control-btn')) return;

    isDragging = true;
    const rect = chatDialog.getBoundingClientRect();
    dragOffsetX = e.clientX - rect.left;
    dragOffsetY = e.clientY - rect.top;

    chatDialog.style.transition = 'none';
});

document.addEventListener('mousemove', function(e) {
    if (!isDragging) return;

    const x = e.clientX - dragOffsetX;
    const y = e.clientY - dragOffsetY;

    chatDialog.style.right = 'auto';
    chatDialog.style.bottom = 'auto';
    chatDialog.style.left = x + 'px';
    chatDialog.style.top = y + 'px';
});

document.addEventListener('mouseup', function() {
    if (isDragging) {
        isDragging = false;
        chatDialog.style.transition = '';
    }
});

// ========== å¯¼èˆªå‡½æ•° ==========
function goHome() {
    if (hasUnsavedChanges) {
        if (!confirm('âš ï¸ æœ‰æœªä¿å­˜çš„ä¿®æ”¹\n\nè¿”å›é¦–é¡µå°†ä¸¢å¤±æœªä¿å­˜çš„ä¿®æ”¹\n\nç¡®å®šè¦è¿”å›å—ï¼Ÿ')) {
            return;
        }
    }
    window.location.href = '03-user-service-selection-ui.html';
}

function goBack() {
    if (confirm('ç¡®å®šè¦è¿”å›æœåŠ¡é€‰æ‹©é¡µé¢å—ï¼Ÿ\n\næœªä¿å­˜çš„å·¥ä½œæµå¯èƒ½ä¼šä¸¢å¤±ã€‚')) {
        window.location.href = '03-user-service-selection-ui.html';
    }
}

// ========== è§†å›¾åˆ‡æ¢åŠŸèƒ½ ==========
function switchView(viewType) {
    currentView = viewType;

    const comfyuiView = document.getElementById('comfyuiView');
    const jsonView = document.getElementById('jsonView');
    const comfyuiBtn = document.getElementById('comfyuiViewBtn');
    const jsonBtn = document.getElementById('jsonViewBtn');

    if (viewType === 'comfyui') {
        // åˆ‡æ¢åˆ° ComfyUI è§†å›¾
        comfyuiView.classList.remove('hidden');
        jsonView.classList.remove('active');
        comfyuiBtn.classList.add('active');
        jsonBtn.classList.remove('active');
    } else if (viewType === 'json') {
        // åˆ‡æ¢åˆ° JSON è§†å›¾
        comfyuiView.classList.add('hidden');
        jsonView.classList.add('active');
        comfyuiBtn.classList.remove('active');
        jsonBtn.classList.add('active');

        // æ¸²æŸ“ JSON å†…å®¹
        renderJsonContent();
    }
}

function renderJsonContent() {
    const jsonContent = document.getElementById('jsonContent');
    jsonContent.textContent = JSON.stringify(workflowJsonData, null, 2);
}

function copyJsonToClipboard() {
    const jsonText = JSON.stringify(workflowJsonData, null, 2);

    // ä½¿ç”¨ Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(jsonText).then(() => {
            alert('âœ… JSON å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            fallbackCopyToClipboard(jsonText);
        });
    } else {
        fallbackCopyToClipboard(jsonText);
    }
}

function fallbackCopyToClipboard(text) {
    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ textarea
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();

    try {
        document.execCommand('copy');
        alert('âœ… JSON å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
    }

    document.body.removeChild(textarea);
}

// ========== é”®ç›˜å¿«æ·é”® ==========
document.addEventListener('keydown', function(e) {
    // Ctrl+S ä¿å­˜å·¥ä½œæµ
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveWorkflow();
    }
});

// ========== åˆå§‹åŒ– ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('ComfyUI Agent å·¥ä½œæµç¼–è¾‘å™¨å·²åŠ è½½');

    // åˆå§‹åŒ–æ¸²æŸ“
    renderSessionList();
    renderWorkflowDropdown();
    renderInitialMessages();

    // æ¼”ç¤ºï¼š5ç§’åæ¨¡æ‹Ÿç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘
    setTimeout(() => {
        console.log('ğŸ’¡ æ¼”ç¤ºæç¤ºï¼š5ç§’åå°†æ¨¡æ‹Ÿç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘å·¥ä½œæµ');
        setTimeout(() => {
            markAsUnsaved();
            alert('ğŸ’¡ æ¼”ç¤ºï¼šæ¨¡æ‹Ÿç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘äº†å·¥ä½œæµ\n\né¡¶éƒ¨çŠ¶æ€å·²å˜ä¸º"æœ‰æœªä¿å­˜çš„ä¿®æ”¹"\n\nä½ å¯ä»¥æŒ‰ Ctrl+S æˆ–ç‚¹å‡»ä¿å­˜æŒ‰é’®ä¿å­˜');
        }, 5000);
    }, 0);
});
</script>
</body>
</html>
